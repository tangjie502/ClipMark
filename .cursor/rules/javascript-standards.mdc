---
globs: *.js
---

# ClipMark JavaScript ä»£ç è§„èŒƒ

## ğŸ“ ç¼–ç æ ‡å‡†

### åŸºç¡€è¯­æ³•è§„èŒƒ
- **åˆ†å·ä½¿ç”¨ï¼š** æ‰€æœ‰è¯­å¥ç»“å°¾å¿…é¡»ä½¿ç”¨åˆ†å·
- **å¼•å·è§„èŒƒï¼š** ç»Ÿä¸€ä½¿ç”¨åŒå¼•å·ï¼Œå­—ç¬¦ä¸²å†…åµŒåŒå¼•å·æ—¶ä½¿ç”¨å•å¼•å·
- **å‘½åçº¦å®šï¼š** 
  - å˜é‡å’Œå‡½æ•°ä½¿ç”¨ camelCaseï¼š`userName`, `downloadFile()`
  - å¸¸é‡ä½¿ç”¨ UPPER_SNAKE_CASEï¼š`DEFAULT_OPTIONS`, `API_BASE_URL`
  - ç±»åä½¿ç”¨ PascalCaseï¼š`ContentExtractor`, `MarkdownConverter`

### å¼‚æ­¥ç¼–ç¨‹è§„èŒƒ
- **ä¼˜å…ˆä½¿ç”¨ async/await** è€Œé Promise chains
- **é”™è¯¯å¤„ç†ï¼š** ä½¿ç”¨ try-catch åŒ…è£…å¼‚æ­¥æ“ä½œ
```javascript
async function downloadMarkdown(content) {
  try {
    const blob = new Blob([content], { type: "text/markdown" });
    const url = URL.createObjectURL(blob);
    return await chrome.downloads.download({ url, filename });
  } catch (error) {
    console.error("ä¸‹è½½å¤±è´¥:", error);
    throw error;
  }
}
```

## ğŸ—ï¸ Chrome Extension API ä½¿ç”¨è§„èŒƒ

### Service Worker å¼€å‘
å‚è€ƒ [service-worker.js](mdc:src/service-worker.js) çš„å®ç°ï¼š
- **äº‹ä»¶ç›‘å¬å™¨ï¼š** ä½¿ç”¨ `chrome.runtime.onInstalled`ã€`chrome.action.onClicked` ç­‰
- **æ¶ˆæ¯ä¼ é€’ï¼š** ä½¿ç”¨ `chrome.runtime.onMessage` å¤„ç†ç»„ä»¶é—´é€šä¿¡
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š** é¿å…é•¿æ—¶é—´è¿è¡Œçš„åå°ä»»åŠ¡

### Storage API ä½¿ç”¨
- **è·å–è®¾ç½®ï¼š** 
```javascript
const options = await chrome.storage.sync.get(DEFAULT_OPTIONS);
```
- **ä¿å­˜è®¾ç½®ï¼š**
```javascript
await chrome.storage.sync.set({ downloadImages: true });
```

### Content Script å¼€å‘
å‚è€ƒ [contentScript.js](mdc:src/contentScript/contentScript.js)ï¼š
- **DOM æ“ä½œï¼š** ç¡®ä¿åœ¨ `document.readyState === "complete"` åæ‰§è¡Œ
- **äº‹ä»¶å¤„ç†ï¼š** ä½¿ç”¨äº‹ä»¶å§”æ‰˜é¿å…å†…å­˜æ³„æ¼
- **æ¶ˆæ¯é€šä¿¡ï¼š** ä½¿ç”¨ `chrome.runtime.sendMessage()` ä¸èƒŒæ™¯è„šæœ¬é€šä¿¡

## ğŸ¯ ç‰¹å®šåŠŸèƒ½å¼€å‘è§„èŒƒ

### Markdown è½¬æ¢å¤„ç†
å‚è€ƒ [background/turndown.js](mdc:src/background/turndown.js)ï¼š
- **é…ç½®è§„èŒƒï¼š** ä½¿ç”¨ç»Ÿä¸€çš„Turndowné…ç½®
- **æ’ä»¶ä½¿ç”¨ï¼š** åŠ è½½GFMï¼ˆGitHub Flavored Markdownï¼‰æ’ä»¶
- **è‡ªå®šä¹‰è§„åˆ™ï¼š** ä¸ºç‰¹æ®ŠHTMLå…ƒç´ å®šä¹‰è½¬æ¢è§„åˆ™

### å†…å®¹æå–é€»è¾‘
å‚è€ƒ [background/Readability.js](mdc:src/background/Readability.js)ï¼š
- **é¡µé¢æ¸…ç†ï¼š** ä½¿ç”¨Mozilla Readability.jsæå–ä¸»è¦å†…å®¹
- **å…ƒæ•°æ®æå–ï¼š** è·å–æ ‡é¢˜ã€ä½œè€…ã€å‘å¸ƒæ—¶é—´ç­‰ä¿¡æ¯
- **å›¾ç‰‡å¤„ç†ï¼š** å¤„ç†ç›¸å¯¹è·¯å¾„å’Œæ‡’åŠ è½½å›¾ç‰‡

### UI ç»„ä»¶å¼€å‘
å‚è€ƒ [popup/popup.js](mdc:src/popup/popup.js)ï¼š
- **äº‹ä»¶ç»‘å®šï¼š** ä½¿ç”¨ `addEventListener` è€Œéå†…è”äº‹ä»¶
- **çŠ¶æ€ç®¡ç†ï¼š** å°†UIçŠ¶æ€ä¸æ‰©å±•å­˜å‚¨åŒæ­¥
- **å“åº”å¼æ›´æ–°ï¼š** æ ¹æ®ç”¨æˆ·æ“ä½œå®æ—¶æ›´æ–°ç•Œé¢

## ğŸ”§ å·¥å…·åº“ä½¿ç”¨è§„èŒƒ

### CodeMirror é›†æˆ
å‚è€ƒ [popup/lib/codemirror.js](mdc:src/popup/lib/codemirror.js)ï¼š
- **ä¸»é¢˜é…ç½®ï¼š** æ”¯æŒäº®è‰²/æš—è‰²ä¸»é¢˜åˆ‡æ¢
- **è¯­æ³•é«˜äº®ï¼š** ä½¿ç”¨Markdownæ¨¡å¼
- **ç¼–è¾‘å™¨é…ç½®ï¼š** è®¾ç½®åˆé€‚çš„è¡Œå·ã€æ¢è¡Œç­‰é€‰é¡¹

### ç¬¬ä¸‰æ–¹åº“ç®¡ç†
- **ç‰ˆæœ¬æ§åˆ¶ï¼š** æ˜ç¡®æŒ‡å®šç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬ï¼Œé¿å…ç ´åæ€§æ›´æ–°
- **å®‰å…¨æ£€æŸ¥ï¼š** å®šæœŸæ£€æŸ¥ä¾èµ–åº“çš„å®‰å…¨æ¼æ´
- **æœ¬åœ°åŒ–ï¼š** å°†ç¬¬ä¸‰æ–¹åº“æœ¬åœ°åŒ–ï¼Œå‡å°‘ç½‘ç»œä¾èµ–

## ğŸš¨ é”™è¯¯å¤„ç†å’Œè°ƒè¯•

### ç»Ÿä¸€é”™è¯¯å¤„ç†
```javascript
function handleError(error, context) {
  console.error(`[${context}] é”™è¯¯:`, error);
  // å‘é€é”™è¯¯æŠ¥å‘Šæˆ–æ˜¾ç¤ºç”¨æˆ·å‹å¥½æ¶ˆæ¯
}
```

### è°ƒè¯•æœ€ä½³å®è·µ
- **æ—¥å¿—åˆ†çº§ï¼š** ä½¿ç”¨ `console.log`ã€`console.warn`ã€`console.error`
- **å¼€å‘æ¨¡å¼ï¼š** åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—
- **ç”Ÿäº§æ¨¡å¼ï¼š** åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å…³é—­è°ƒè¯•ä¿¡æ¯

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### å†…å­˜ç®¡ç†
- **åŠæ—¶æ¸…ç†ï¼š** ç§»é™¤ä¸å†ä½¿ç”¨çš„äº‹ä»¶ç›‘å¬å™¨
- **é¿å…å†…å­˜æ³„æ¼ï¼š** æ³¨æ„é—­åŒ…ä¸­çš„å˜é‡å¼•ç”¨
- **åˆç†ç¼“å­˜ï¼š** ç¼“å­˜é¢‘ç¹è®¿é—®çš„æ•°æ®ï¼Œä½†é¿å…è¿‡åº¦ç¼“å­˜

### åŠ è½½ä¼˜åŒ–
- **æŒ‰éœ€åŠ è½½ï¼š** å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
- **ä»£ç åˆ†å‰²ï¼š** å°†å¤§å‹è„šæœ¬æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—
- **èµ„æºå‹ç¼©ï¼š** åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‹ç¼©JavaScriptæ–‡ä»¶